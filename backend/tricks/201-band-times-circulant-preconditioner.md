# 201: Band-Times-Circulant Preconditioner for Ill-Conditioned Toeplitz Systems

**Category**: decomposition
**Gain type**: efficiency
**Source**: Noutsos, D. & Vassalos, P. "Superlinear convergence for PCG using band plus algebra preconditioners for Toeplitz systems" Comput. Math. Appl. 56(5):1255-1270, 2008; Noutsos, D. & Tachyridis, G. "Band-times-circulant preconditioners for non-symmetric Toeplitz systems" BIT Numer. Math. 62:561-590, 2022
**Paper**: [papers/band-times-circulant-preconditioner.pdf]
**Documented**: 2026-02-15

## Description

When a Toeplitz matrix $A_n = A_n(f)$ is **ill-conditioned** — meaning its generating function $f(\theta)$ has zeros on $[-\pi, \pi]$ — standard circulant preconditioners (Strang, T. Chan, superoptimal) fail to deliver fast convergence because the preconditioned system inherits the ill-conditioning from the zeros of $f$. Conversely, **band Toeplitz** preconditioners $B_m$ (generated by a low-degree trigonometric polynomial that shares the zeros of $f$) can remove the ill-conditioning but cannot by themselves produce superlinear PCG convergence.

The **band-times-circulant** preconditioner resolves this by taking the **product**:

$$
P_n = B_m \cdot C_n(g)
$$

where $B_m = A_n(q)$ is a band Toeplitz matrix generated by a trigonometric polynomial $q$ of degree $m$ that approximates the zeros of $f$, and $C_n(g)$ is a circulant matrix generated by $g = f/q$ (the "desingularized" generating function). This product:

1. **Removes ill-conditioning**: $B_m$ captures the zeros of $f$, so $g = f/q$ is well-conditioned
2. **Provides superlinear convergence**: $C_n(g)$ preconditions the well-conditioned quotient, clustering eigenvalues at 1
3. **Achieves $O(n \log n)$ application cost**: $B_m$ is banded ($O(mn)$ matvec) and $C_n$ is circulant ($O(n \log n)$ via FFT)

This is a critical result because Serra-Capizzano and Tyrtyshnikov proved that **no single circulant-like preconditioner can achieve superlinear convergence** for ill-conditioned Toeplitz systems. The product structure is essential — it factors the problem into a "zero-removal" step and a "clustering" step, each handled by the appropriate matrix class.

The connection to the circulant cycle decomposition (Trick 028) is direct: the circulant component $C_n(g)$ corresponds to the dominant cycle of the desingularized matrix $A_n(g) = A_n(f/q)$, while the band Toeplitz $B_m$ handles the cycles that would otherwise have unbounded energy due to the zeros of $f$.

## Mathematical Form

**Generating Function Setting:**

The Toeplitz matrix $A_n = A_n(f)$ has generating function $f \in L^1([-\pi, \pi])$:

$$
f(\theta) = \sum_{k=-\infty}^{\infty} a_k e^{-ik\theta}, \quad a_k = \frac{1}{2\pi}\int_{-\pi}^{\pi} f(\theta) e^{-ik\theta} d\theta
$$

**Ill-Conditioning from Zeros:**

When $f(\theta_0) = 0$ for some $\theta_0$, the condition number $\kappa(A_n) \to \infty$ as $n \to \infty$. If $f$ has a zero of order $2p$ at $\theta_0$:

$$
f(\theta) \sim |\theta - \theta_0|^{2p} \cdot h(\theta), \quad h(\theta_0) \neq 0
$$

then $\kappa(A_n) = O(n^{2p})$.

**Band Toeplitz Approximation of Zeros:**

Choose a trigonometric polynomial $q$ of degree $m$ that shares the zeros of $f$:

$$
q(\theta) = \sum_{k=-m}^{m} q_k e^{-ik\theta}, \quad q(\theta_0) = 0 \text{ with same order as } f
$$

The corresponding band Toeplitz matrix $B_m = A_n(q)$ has bandwidth $2m+1$.

**Desingularized Quotient:**

$$
g(\theta) = \frac{f(\theta)}{q(\theta)}
$$

Since $q$ shares the zeros of $f$ with the same orders, $g$ is well-conditioned: $0 < \delta \leq g(\theta) \leq \Delta < \infty$.

**Product Preconditioner:**

$$
P_n = B_m \cdot C_n(g)
$$

where $C_n(g)$ is the optimal circulant preconditioner for $A_n(g)$, with eigenvalues $g(2\pi j/n)$, $j = 0, \ldots, n-1$.

**Eigenvalue Clustering (Key Result):**

The preconditioned matrix satisfies:

$$
P_n^{-1} A_n = C_n(g)^{-1} B_m^{-1} A_n(f)
$$

Since $A_n(f) \approx B_m \cdot A_n(g)$ and $C_n(g)^{-1} A_n(g)$ has eigenvalues clustering at 1 (by Szego theory for well-conditioned Toeplitz), the preconditioned system has eigenvalues clustering at 1 with **superlinear rate**.

**Superlinear Convergence Bound:**

For PCG with preconditioner $P_n$, the error at step $k$ satisfies:

$$
\|e_k\|_{A_n} \leq 2 \left(\frac{\sqrt{\kappa_k} - 1}{\sqrt{\kappa_k} + 1}\right)^k \|e_0\|_{A_n}
$$

where $\kappa_k$ is the effective condition number after removing the $k$ outlier eigenvalues. Since eigenvalues cluster at 1, $\kappa_k \to 1$ as $k$ grows, giving **superlinear** convergence: each additional iteration provides more than proportional error reduction.

**Extension to Non-Symmetric Case (Noutsos & Tachyridis 2022):**

For non-symmetric Toeplitz $A_n(f)$ with complex-valued $f$, the preconditioner becomes:

$$
P_n = B_m \cdot C_n(|g|) \quad \text{or} \quad P_n = B_m \cdot |C_n(g)|
$$

combined with GMRES or symmetrized MINRES (see Trick 200).

**Key Definitions:**

- $f(\theta)$ — generating function of the Toeplitz matrix $A_n$
- $q(\theta)$ — trigonometric polynomial of degree $m$ approximating zeros of $f$
- $g(\theta) = f(\theta)/q(\theta)$ — desingularized generating function
- $B_m = A_n(q)$ — band Toeplitz matrix (bandwidth $2m+1$)
- $C_n(g)$ — circulant preconditioner for the well-conditioned part
- $P_n = B_m \cdot C_n(g)$ — product (band-times-circulant) preconditioner

## Complexity

| Operation | Circulant alone | Band Toeplitz alone | Band-times-circulant $P_n$ |
|-----------|----------------|--------------------|-----------------------------|
| Preconditioner apply | $O(n \log n)$ | $O(mn)$ | $O(n \log n + mn)$ |
| PCG convergence | Not superlinear (ill-cond.) | Not superlinear | **Superlinear** |
| Iterations to $\epsilon$ | $O(n^p)$ for zero of order $2p$ | $O(\sqrt{\kappa_{\text{res}}})$ | $O(\log \log(1/\epsilon))$ eventually |
| Setup cost | $O(n \log n)$ | $O(m)$ | $O(n \log n + m)$ |
| Storage | $O(n)$ | $O(m)$ | $O(n + m)$ |

**Practical iteration counts (from literature):**

For Toeplitz matrices with generating function $f(\theta) = (2 - 2\cos\theta)$ (zero of order 2 at $\theta = 0$, condition number $O(n^2)$):

| Preconditioner | $n = 512$ | $n = 2048$ | $n = 8192$ | Convergence type |
|---------------|-----------|------------|------------|-----------------|
| Strang circulant $C_n^{(S)}$ | 28 | 35 | 43 | Sublinear |
| Optimal circulant $C_n$ | 20 | 26 | 33 | Sublinear |
| Band Toeplitz $B_1$ | 15 | 15 | 15 | Linear (mesh-indep.) |
| $B_1 \cdot C_n$ | 7 | 8 | 8 | **Superlinear** |

**Memory:** $O(n)$ for circulant (first row) + $O(m)$ for band Toeplitz ($m$ diagonals), total $O(n + m)$.

## Applicability

- **Ill-conditioned Toeplitz token mixers**: In sequence models where the Toeplitz mixing matrix has a generating function with zeros (e.g., derivative-like operators, high-pass filters), standard circulant preconditioning for implicit layers fails. The band-times-circulant approach provides mesh-independent, superlinear convergence by factoring out the ill-conditioning
- **Training implicit Toeplitz layers**: When using implicit differentiation through Toeplitz-structured layers (e.g., deep equilibrium models with convolutional structure), the backward pass requires solving $(I - J)^{-1} v$ where $J$ is Toeplitz. If $J$ has spectral radius close to 1, the system is ill-conditioned and benefits from the band-times-circulant preconditioner
- **Fractional diffusion operators in neural ODEs**: Discretization of fractional Laplacians produces Toeplitz matrices with generating functions of the form $f(\theta) = |1 - e^{i\theta}|^{2\alpha}$ which have zeros at $\theta = 0$ of order $2\alpha$. The band-times-circulant preconditioner with $q(\theta) = (2 - 2\cos\theta)^{\lceil\alpha\rceil}$ removes the zero and enables efficient solving
- **Multi-scale convolutional networks**: Block Toeplitz systems arising from multi-scale convolutions (where different scales introduce zeros at different frequencies) can be preconditioned by the multi-level extension using block band Toeplitz times block circulant products
- **Connection to circulant cycle decomposition**: The desingularized matrix $A_n(g) = A_n(f/q)$ has a much sparser cycle structure (in the sense of Trick 028) than $A_n(f)$, because the zeros of $f$ cause many cycles to have large weights. By factoring out $B_m$, the remaining circulant component needs far fewer dominant cycles for accurate approximation

## Limitations

- **Requires knowledge of generating function zeros**: The band Toeplitz component $B_m$ must approximate the zeros of $f$, which requires knowing (or estimating) where $f$ vanishes. For learned Toeplitz layers where $f$ is not known analytically, one must estimate zeros from the learned parameters
- **Band Toeplitz inversion cost**: Applying $B_m^{-1}$ exactly costs $O(m^2 n)$ via banded Cholesky/LU. For small bandwidth $m \ll n$, this is acceptable. For larger $m$, approximate inversion (e.g., a few Jacobi iterations on $B_m$) may be needed
- **Symmetric positive definite assumption**: The original superlinear convergence result (Noutsos & Vassalos 2008) requires $f \geq 0$ (Hermitian positive semidefinite Toeplitz). The non-symmetric extension (Noutsos & Tachyridis 2022) uses GMRES, which does not have the same superlinear convergence guarantees
- **GPU parallelism**: The PCG/MINRES loop is inherently sequential. Each iteration consists of a banded matvec ($O(mn)$, parallelizable) + FFT ($O(n \log n)$, parallelizable) + vector operations, but the iteration-to-iteration dependency limits throughput. For small iteration counts (8-15), the overhead of launching multiple kernels per iteration may dominate
- **Not applicable to unstructured attention**: This technique requires Toeplitz structure with a known or estimable generating function. It does not apply to general dense attention matrices
- **Multilevel limitations**: Serra-Capizzano proved that no circulant-like preconditioner can be superlinear for multilevel Toeplitz matrices. The band-times-circulant approach partially addresses this, but the multilevel case remains harder

## Implementation Notes

```python
import torch
import torch.fft as fft


def band_times_circulant_preconditioner(A_col, A_row, zero_info,
                                         band_degree=None):
    """Construct band-times-circulant preconditioner P = B_m * C_n(g).

    For ill-conditioned Toeplitz systems where the generating function
    f has zeros, standard circulant preconditioners fail. This constructs
    P_n = B_m * C_n(g) where:
    - B_m captures the zeros of f (band Toeplitz, bandwidth 2m+1)
    - C_n(g) preconditions the well-conditioned quotient g = f/q

    Args:
        A_col: (n,) first column of Toeplitz matrix A_n(f)
        A_row: (n,) first row of Toeplitz matrix A_n(f)
        zero_info: list of (theta_0, order) tuples describing zeros of f
        band_degree: degree m of the band polynomial (auto if None)

    Returns:
        precond_apply: function P^{-1} @ v
        info: dict with preconditioner details
    """
    n = len(A_col)

    # Step 1: Construct band polynomial q(theta) from zero info
    # q(theta) = product of (2 - 2*cos(theta - theta_0))^order
    if band_degree is None:
        band_degree = sum(order for _, order in zero_info)

    # Evaluate f on uniform grid
    theta = torch.linspace(0, 2 * torch.pi, n, dtype=torch.float64)
    # f(theta) from Toeplitz coefficients
    f_vals = torch.zeros(n, dtype=torch.complex128)
    for k in range(n):
        f_vals += A_col[k] * torch.exp(-1j * k * theta)
    for k in range(1, n):
        f_vals += A_row[k] * torch.exp(1j * k * theta)

    # q(theta) = product of zero-capturing factors
    q_vals = torch.ones(n, dtype=torch.complex128)
    for theta_0, order in zero_info:
        factor = 2 - 2 * torch.cos(theta - theta_0)
        q_vals *= factor.pow(order).to(torch.complex128)

    # Step 2: g(theta) = f(theta) / q(theta) — well-conditioned
    g_vals = f_vals / q_vals

    # Step 3: Build circulant C_n(g) via FFT
    # Eigenvalues of C_n(g) are g(2*pi*j/n)
    g_eigs = g_vals  # Already evaluated at uniform grid

    # Step 4: Build band Toeplitz B_m from q
    # Get Fourier coefficients of q
    q_coeffs = fft.ifft(q_vals).real
    m = band_degree

    # Step 5: Preconditioner application P^{-1} v = C_n(g)^{-1} B_m^{-1} v
    def precond_apply(v):
        v = v.to(torch.complex128)

        # Step 5a: Solve B_m @ w = v (banded system)
        # For small m, use banded LU/Cholesky
        # Simplified: use circulant approximation of B_m for demo
        q_eigs_circ = fft.fft(q_vals)
        v_fft = fft.fft(v)
        w = fft.ifft(v_fft / q_eigs_circ)

        # Step 5b: Solve C_n(g) @ x = w (circulant system via FFT)
        w_fft = fft.fft(w)
        x = fft.ifft(w_fft / g_eigs)

        return x.real.to(torch.float32)

    info = {
        'band_degree': band_degree,
        'n': n,
        'g_condition': (g_vals.abs().max() / g_vals.abs().min()).item(),
        'f_condition': (f_vals.abs().max() /
                        (f_vals.abs().min() + 1e-15)).item(),
    }

    return precond_apply, info


def estimate_generating_function_zeros(A_col, A_row, threshold=0.01):
    """Estimate zeros of generating function from Toeplitz coefficients.

    For learned Toeplitz layers, the generating function is not known
    analytically. This estimates zeros by evaluating f on a fine grid
    and finding local minima below threshold.

    Args:
        A_col: (n,) first column
        A_row: (n,) first row
        threshold: relative threshold for zero detection

    Returns:
        zero_info: list of (theta, estimated_order) tuples
    """
    n = len(A_col)
    # Evaluate |f(theta)| on fine grid
    N_grid = max(4 * n, 1024)
    theta = torch.linspace(0, 2 * torch.pi, N_grid)
    f_vals = torch.zeros(N_grid, dtype=torch.complex128)
    for k in range(n):
        f_vals += A_col[k].to(torch.complex128) * torch.exp(-1j * k * theta)
    for k in range(1, n):
        f_vals += A_row[k].to(torch.complex128) * torch.exp(1j * k * theta)

    f_abs = f_vals.abs()
    f_max = f_abs.max()
    thresh = threshold * f_max

    # Find local minima below threshold
    zeros = []
    for i in range(1, N_grid - 1):
        if (f_abs[i] < thresh and
            f_abs[i] <= f_abs[i-1] and
            f_abs[i] <= f_abs[i+1]):
            # Estimate order from log-log slope
            # |f(theta)| ~ |theta - theta_0|^p near zero
            theta_0 = theta[i].item()
            # Use nearby values to estimate order
            delta = theta[1].item() - theta[0].item()
            if f_abs[i] > 1e-15:
                log_f = torch.log(f_abs[max(i-5,0):i+6] + 1e-30)
                log_t = torch.log(
                    (theta[max(i-5,0):i+6] - theta_0).abs() + 1e-30)
                # Simple linear regression for order
                valid = (theta[max(i-5,0):i+6] - theta_0).abs() > delta
                if valid.sum() > 2:
                    order = max(1, round(
                        (log_f[valid][-1] - log_f[valid][0]).item() /
                        (log_t[valid][-1] - log_t[valid][0]).item()
                    ))
                else:
                    order = 1
            else:
                order = 1
            zeros.append((theta_0, order))

    return zeros


# Example: Precondition a Toeplitz system from a 1D Laplacian
def demo_laplacian_preconditioner():
    """
    Demo: solve (-Delta) * x = b discretized as Toeplitz.
    Generating function: f(theta) = 2 - 2*cos(theta), zero at theta=0.
    """
    n = 1024

    # Tridiagonal Laplacian: A_col = [2, -1, 0, 0, ...], A_row same
    A_col = torch.zeros(n)
    A_col[0] = 2.0
    A_col[1] = -1.0
    A_row = A_col.clone()

    b = torch.randn(n)

    # Zero at theta=0, order 2
    zero_info = [(0.0, 1)]  # (2-2*cos(theta))^1 captures order-2 zero

    precond_apply, info = band_times_circulant_preconditioner(
        A_col, A_row, zero_info, band_degree=1
    )

    print(f"Original condition: {info['f_condition']:.1f}")
    print(f"After desingularization: {info['g_condition']:.4f}")
    # g_condition should be close to 1 (well-conditioned)

    return precond_apply
```

## References

- Noutsos, D. & Vassalos, P. "Superlinear convergence for PCG using band plus algebra preconditioners for Toeplitz systems" Computers & Mathematics with Applications, 56(5):1255-1270, 2008
- Noutsos, D. & Tachyridis, G. "Band-times-circulant preconditioners for non-symmetric Toeplitz systems" BIT Numerical Mathematics, 62:561-590, 2022. DOI: 10.1007/s10543-021-00883-y
- Noutsos, D. & Tachyridis, G. "Band-Toeplitz preconditioners for ill-conditioned Toeplitz systems" BIT Numerical Mathematics, 62:591-613, 2022. DOI: 10.1007/s10543-021-00889-6
- Serra-Capizzano, S. & Tyrtyshnikov, E. "Any circulant-like preconditioner for multilevel matrices is not superlinear" SIAM J. Matrix Anal. Appl. 21:431-439, 1999
- Serra-Capizzano, S. & Tyrtyshnikov, E. "How to prove that a preconditioner cannot be superlinear" Math. Comp. 72(243):1305-1316, 2003
- Pestana, J. "Preconditioners for Symmetrized Toeplitz and Multilevel Toeplitz Matrices" SIAM J. Matrix Anal. Appl. 40(3):870-887, 2019 (Trick 200)
- Hariprasad, M. & Venkatapathi, M. "Circulant decomposition of a matrix and the eigenvalues of Toeplitz type matrices" Applied Math. & Computation, 2024 (Trick 028)
- Chan, T.F. "An Optimal Circulant Preconditioner for Toeplitz Systems" SIAM J. Sci. Stat. Comput. 9(4):766-771, 1988 (Trick 084)
